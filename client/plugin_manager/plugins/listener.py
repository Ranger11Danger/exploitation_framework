from plugin_manager.manager import plugin_manager
from cmd2 import with_argparser
import argparse
import socket
import threading
import time
import select
import sys
argparser = argparse.ArgumentParser()
argparser.add_argument('-p', help="Port to listen on", required=True)


class test(plugin_manager):

    
    @with_argparser(argparser)
    def do_listen(self, args):
        def listen(setport):
            host = "0.0.0.0"
            port = int(setport)
            s = socket.socket()
            s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            s.bind((host, port))
            s.listen(5)
            inputs = [s.fileno()]
            outputs = []
            while inputs:
                readable,writable,exceptional = select.select(inputs,outputs,inputs)
                for x in readable:
                    #We have a new connection handle it
                    if x == s.fileno():
                        conn,addr = s.accept()
                        print(f"connection from {addr[0]}:{addr[1]}")
                        self.connections.append(conn)
                        self.addresses.append(addr)
                        readable.remove(x)
                
    
        def check_conns():
            print("Checking Connections")
            while True:
                time.sleep(2)
                for key,value in enumerate(self.connections):
                    value.send("syn".encode())
                    data = value.recv(1024)
                    if data.decode() != "synack":
                        print(f"connection lost from session {key}")
                        self.connections.pop(key)
                        self.addresses.pop(key)
                        if int(self.current_session) == key:
                            self.prompt = "> "
        
        check_thread = threading.Thread(target=check_conns)
        check_thread.daemon = True
        #check_thread.start()
        port = args.p
        t = threading.Thread(target=listen, args=[port])
        t.daemon = True
        t.start()
        print(f"Now listening on port {port}")
